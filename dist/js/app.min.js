function nonce_generate(){"use strict";return Math.floor(1e12*Math.random()).toString()}function initMap(){"use strict";if("undefined"==typeof google)alert("error: google failed to load");else{var latLng={lat:41.994654,lng:-73.875959};map=new google.maps.Map(document.getElementById("map"),{center:latLng,zoom:16}),searchYelp("food","Red+Hook,NY+12571","restaurants,bars"),filterBox.on("input",function(){filterInput=$(this).val(),filterLocations(filterInput,yelpResults)}).trigger("input")}}function createMarkers(locationData,map){"use strict";var yelpLogo="./images/yelp-logo-xsmall.png";locationData.businesses.forEach(function(business){var latLng={lat:business.location.coordinate.latitude,lng:business.location.coordinate.longitude},name=business.name,phoneNum=business.display_phone,description=business.snippet_text,businessURL=business.url,ratingImg=business.rating_img_url_small,reviewCount=business.review_count,img=business.image_url,contentString='<div id="content"><div id="placeImg"><img src="'+img+'"></img></div><div id="yelpLogo"><a href="http://www.yelp.com" target="_blank"><img src="'+yelpLogo+'"></img></a></div><h3 id="placeName">'+name+'</h3><img src="'+ratingImg+'"></img>('+reviewCount+')<p><a href="tel: +'+phoneNum+'">'+phoneNum+"</a></p><p>"+description+'<a href="'+businessURL+'" target="_blank">(read more...)</a></p></div>',infowindow=new google.maps.InfoWindow({content:contentString,maxWidth:350});markers[name]=new google.maps.Marker({position:latLng,map:map,animation:google.maps.Animation.DROP,title:name}),markers[name].addListener("click",function(){currentInfoWindow&&(currentInfoWindow.close(),currentMarker.setAnimation(null)),currentInfoWindow=infowindow,currentMarker=markers[name],infowindow.open(map,markers[name]),markers[name].setAnimation(google.maps.Animation.BOUNCE),google.maps.event.addListener(infowindow,"closeclick",function(){currentMarker.setAnimation(null)})})})}function searchYelp(termVal,locationVal,categoryVal){"use strict";var httpMethod="GET",url="http://api.yelp.com/v2/search?",parameters={location:locationVal,term:termVal,category_filter:categoryVal,oauth_consumer_key:oauth_consumer_keyVal,oauth_token:oauth_tokenVal,oauth_nonce:nonce_generate(),oauth_timestamp:Math.floor(Date.now()/1e3),oauth_signature_method:oauth_signature_methodVal,callback:"cb"},consumerSecret="Xzz7g7qJMMY6-rs8zX8KTtxtBZY",tokenSecret="oZstoMIkks8R3kXJGM5uFzDipas",encodedSignature=oauthSignature.generate(httpMethod,url,parameters,consumerSecret,tokenSecret);parameters.oauth_signature=encodedSignature;var settings={url:url,data:parameters,cache:!0,dataType:"jsonp",jsonpCallback:"cb",success:function(results){createMarkers(results,map),yelpResults=results},error:function(error){alert("Warning: Cannot load location data!")}};$.ajax(settings)}function FilterViewModel(){var self=this;self.filteredLocations=ko.observableArray(),self.removeDuplicates=function(){current=self.filteredLocations()[0];for(var i=0;i<self.filteredLocations().length;i++)current.name===self.filteredLocations()[i].name?self.filteredLocations()[i].name="erase":current=self.filteredLocations()[i];self.filteredLocations.remove(function(locationPiece){return"erase"===locationPiece.name})},self.compareMarkers=function(marker,toBreak,location){return location.name===markers[marker].title?(markers[marker].setMap(map),toBreak=!0):void(toBreak===!1&&markers[marker].setMap(null))},self.setMarkers=function(){for(var marker in markers)if(!markers.hasOwnProperty(markers[marker])){var toBreak=!1;for(var location in filteredLocations())filteredLocations().hasOwnProperty(location)&&(toBreak=compareMarkers(marker,toBreak,filteredLocations()[location]))}},self.filterLocations=function(input,locationData){var findAll=!1;""===input&&(findAll=!0),locationData.businesses.forEach(function(business){var name=business.name,categoryArray=business.categories,address=business.location.display_address,latLng={lat:business.location.coordinate.latitude,lng:business.location.coordinate.longitude},location=[business.location.city,business.location.neighborhoods,business.location.state_code],found=!1;categoryArray.forEach(function(categories){categories.forEach(function(category){(!found&&category.toLowerCase().contains(input.toLowerCase())||findAll===!0)&&(self.filteredLocations.push({name:name,address:address[0]+" "+address[1],category:categoryArray[0][0],latLng:latLng}),found=!0)})}),found||location.forEach(function(locationPiece){!found&&void 0!==locationPiece&&locationPiece.toLowerCase().contains(input.toLowerCase())&&(self.filteredLocations.push({name:name,address:address[0]+" "+address[1],category:categoryArray[0][0],latLng:latLng}),found=!0)}),found||address.forEach(function(addressPiece){!found&&addressPiece.toLowerCase().contains(input.toLowerCase())&&(self.filteredLocations.push({name:name,address:address[0]+" "+address[1],category:categoryArray[0][0],latLng:latLng}),found=!0)}),name.toLowerCase().contains(input.toLowerCase())&&!found&&(self.filteredLocations.push({name:name,address:address[0]+" "+address[1],category:categoryArray[0][0],latLng:latLng}),found=!0),found||self.filteredLocations.remove(function(locationPiece){return locationPiece.name===name}),found=!1}),self.filteredLocations.sort(function(left,right){return left.name==right.name?0:left.name<right.name?-1:1}),removeDuplicates(),setMarkers()},self.centerMap=function(location){menu.removeClass("is-active"),filterBox.blur(),map.setCenter(location.latLng),google.maps.event.trigger(markers[location.name],"click"),markers[location.name].setAnimation(google.maps.Animation.BOUNCE)}}var map,currentInfoWindow=!1,yelpResults,markers={},currentMarker,filterInput=ko.observable("");"contains"in String.prototype||(String.prototype.contains=function(str,startIndex){"use strict";return-1!==String.prototype.indexOf.call(this,str,startIndex)});var baseURL="https://api.yelp.com/v2/search?",oauth_consumer_keyVal="o7io1ZSwVn_Gcxj4MqsgkQ",oauth_tokenVal="3Rka9DQ66lV8bxGac4DSEcgt6Ze95TfM",oauth_signature_methodVal="HMAC-SHA1",oauth_signatureVal="oZstoMIkks8R3kXJGM5uFzDipas",oauth_timestamp="&oauth_timestamp=",oauth_nonce="&oauth_nonce=";ko.applyBindings(FilterViewModel);var filterBox=$(".filter-box"),menu=$(".filter-menu"),closeButton=$(".close-button"),map=$("#map");map.click(function(){menu.removeClass("is-active"),filterBox.blur()}),filterBox.focus(function(){menu.addClass("is-active"),filterLocations(filterInput,yelpResults)}),closeButton.click(function(){menu.removeClass("is-active")});